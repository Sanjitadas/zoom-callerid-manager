<!-- templates/index.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Dashboard Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">Admin Dashboard</h2>
  </div>

  <!-- Unified Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card text-center p-3 shadow-sm">
        <h5>Total Admins</h5>
        <h2 id="total-admins">{{ total_admins }}</h2>
        <i class="bi bi-person-badge-fill fs-3 text-primary"></i>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center p-3 shadow-sm">
        <h5>Allowed Users</h5>
        <h2 id="total-allowed-users">{{ total_allowed_users }}</h2>
        <i class="bi bi-people-fill fs-3 text-success"></i>
        <div class="d-flex justify-content-around mt-3">
          <div>
            <span id="total-allowed-users-online" class="badge bg-success">{{ online_count }}</span>
            <p class="mb-0">Online</p>
          </div>
          <div>
            <span id="total-allowed-users-offline" class="badge bg-danger">{{ offline_count }}</span>
            <p class="mb-0">Offline</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center p-3 shadow-sm">
        <h5>Caller ID Updates</h5>
        <h2 id="total-callerid-updates">{{ total_callerid_updates }}</h2>
        <i class="bi bi-telephone-fill fs-3 text-warning"></i>
      </div>
    </div>
  </div>

  <!-- Allowed Users Section -->
  <div class="mb-5">
    <h5 class="mb-3">Allowed Users</h5>
    <div id="allowed-users-table">
      {% include "partials/allowed_users_list.html" %}
    </div>
  </div>

  <!-- Recent Caller ID Updates Section -->
  <div class="mb-5">
    <h5 class="mb-3">Recent Caller ID Updates</h5>
    <div id="recent-callerid-updates">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Time</th>
            <th>By User</th>
            <th>Type</th>
            <th>Caller ID</th>
          </tr>
        </thead>
        <tbody>
          {% for u in dashboard_updates %}
          <tr>
            <td>{{ u.time }}</td>
            <td>{{ u.user }}</td>
            <td>{{ u.update_type }}</td>
            <td>{{ u.caller_id_number }}</td>
          </tr>
          {% endfor %}
          {% if dashboard_updates|length == 0 %}
          <tr>
            <td colspan="4" class="text-muted text-center">No caller ID updates yet.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- AJAX Refresh Scripts -->
<script>
async function refreshCallerIDTable() {
  try {
    const res = await fetch("{{ url_for('main.ajax_refresh_dashboard') }}");
    const data = await res.json();
    if (data.status === "success") {
      const tbody = document.querySelector("#recent-callerid-updates tbody");
      if(tbody) {
        tbody.innerHTML = data.recent_updates_html.trim() !== "" 
          ? data.recent_updates_html 
          : `<tr><td colspan="4" class="text-muted text-center">No caller ID updates yet.</td></tr>`;
      }

      const totalElem = document.querySelector("#total-callerid-updates");
      if(totalElem) totalElem.textContent = data.total_callerid_updates;
    }
  } catch(err) {
    console.error("Failed to refresh Caller ID table", err);
  }
}

async function refreshAllowedUsers() {
  try {
    const res = await fetch("{{ url_for('main.ajax_refresh_allowed_users') }}");
    const data = await res.json();
    if (data.status === "success") {
      const container = document.querySelector("#allowed-users-table");
      if (container) container.innerHTML = data.allowed_users_html;

      const onlineBadge = document.querySelector("#total-allowed-users-online");
      const offlineBadge = document.querySelector("#total-allowed-users-offline");
      if(onlineBadge) onlineBadge.textContent = data.online_count;
      if(offlineBadge) offlineBadge.textContent = data.offline_count;
    }
  } catch(err) {
    console.error("Failed to refresh Allowed Users", err);
  }
}

// Refresh every 15 seconds
setInterval(refreshCallerIDTable, 15000);
setInterval(refreshAllowedUsers, 15000);

document.addEventListener("DOMContentLoaded", () => {
  refreshCallerIDTable();
  refreshAllowedUsers();
});
</script>

<!-- Custom Styles -->
<style>
.badge {
    font-size: 1rem;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    line-height: 20px;
}

/* Optional: Dark Theme */
.dark-theme {
    background-color: #121212;
    color: #e0e0e0;
}
.dark-theme .card {
    background-color: #1e1e1e;
    color: #e0e0e0;
}
.dark-theme table.table {
    color: #e0e0e0;
}
.dark-theme thead.table-light {
    background-color: #2c2c2c !important;
    color: #e0e0e0 !important;
}
</style>
{% endblock %}




















































